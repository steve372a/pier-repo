name: Pier Auto Update

on:
  push:
    branches: [ main ]  # 当有新代码推送到 main 分支时触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # 使用 Linux 虚拟机，完全免费
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4  # 获取仓库内容

      - name: Generate Database Files
        run: |
          # 1. 定义变量
          PIE_DIR="./sources"
          OUTPUT_FILE="./db.sque"
          DBM_FILE="./dbm.sque"

          # 2. 清理
          rm -f $OUTPUT_FILE $DBM_FILE
          touch $OUTPUT_FILE

          # 3. 扫描压缩包并提取描述
          find "$PIE_DIR" -maxdepth 1 -name "*.metadata" -print0 | while IFS= read -r -d '' zipfile; do
              pkgname=$(basename -- "$zipfile" .metadata)
              
              # 【核心逻辑】从压缩包里提取 metadata.sque 的内容
              # 然后用 sed 找到 [ProFile] 标记并提取其下一行
              profile=$(unzip -p "$zipfile" "metadata.sque" | sed -n '/\[ProFile\]/{n;p;}' | tr -d '\r' | xargs)

              # 如果没取到描述，给个保底
              if [ -z "$profile" ]; then profile="无描述"; fi

              # 按照 XP 兼容格式拼接：包名 | 简介
              printf "%s | %s\r\n" "$pkgname" "$profile" >> "$OUTPUT_FILE"
          done

          # 4. 自然排序
          sort -V "$OUTPUT_FILE" -o "$OUTPUT_FILE"

          # 5. 生成统计
          count=$(wc -l < "$OUTPUT_FILE")
          printf "%d" "$count" > "$DBM_FILE"

          echo "Database update complete. Integrated $count package profiles."
